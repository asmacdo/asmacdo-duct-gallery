# Data Model: Gallery Markdown Output

## Entities

### GalleryEntry
Represents a single gallery entry to be executed and rendered.

**Fields**:
- `name`: str - Entry directory name (kebab-case)
- `path`: Path - Absolute path to entry directory
- `setup_script`: Path - Path to setup.sh
- `command_script`: Path - Path to command.sh
- `command_text`: str - Contents of command.sh (for markdown display)
- `usage_json`: Path - Path to generated .duct/usage.json
- `plot_path`: Path - Path to generated plot image
- `metadata`: dict - Contents of metadata.json (optional)

**Validation Rules**:
- `name`: Must match directory name, kebab-case format
- `path`: Must be a directory
- `setup_script`: Must exist and be executable
- `command_script`: Must exist and be executable
- `command_text`: Extracted from command.sh for display
- `usage_json`: Generated by duct execution
- `plot_path`: Generated from usage.json by con-duct

**State/Lifecycle**:
1. **Discovered**: Entry directory found during scan
2. **Validated**: Required files (setup.sh, command.sh) exist
3. **Setup**: setup.sh executed successfully
4. **Executed**: command.sh executed, produces usage.json
5. **Plotted**: Plot generated from usage.json
6. **Ready**: Entry can be rendered to markdown

**Relationships**:
- GalleryEntry (many) → MarkdownOutput (one)
- Entry is independent, no cross-entry references

---

### MarkdownOutput
Represents the generated consolidated markdown file.

**Fields**:
- `output_path`: Path - Where to write the markdown file
- `entries`: List[GalleryEntry] - Gallery entries to include
- `content`: str - Generated markdown content

**Validation Rules**:
- `output_path`: Must be writable location
- `entries`: Must have at least one entry
- `content`: Must be valid markdown (basic syntax check)

**Generation Rules**:
- Each entry becomes a section with heading, code block, and image
- Entries ordered by discovery order (directory listing)
- Image paths calculated as relative from output_path to entry plot_path

---

## Data Flow

```
1. Validate output path
   → Fail fast if invalid

2. Scan gallery/ directory
   → Discover entry directories

3. For each entry directory:
   → Validate structure (setup.sh, command.sh exist)
   → Create GalleryEntry instance

4. For each GalleryEntry:
   → Execute setup.sh
   → Execute command.sh (produces .duct/usage.json)
   → Generate plot from usage.json using con-duct
   → Read command_text from command.sh
   → Mark entry as Ready

5. Generate MarkdownOutput:
   → For each Ready entry: format section
   → Concatenate sections
   → Add header

6. Write MarkdownOutput.content to output_path
```

## Validation

### Entry Directory Validation
```python
Required:
- setup.sh exists and is executable
- command.sh exists and is executable

Optional:
- metadata.json (parse if exists)
- README.md (ignore, documentation)
- .duct/ directory (created by execution)
- plots/ directory (created by con-duct)
```

### Output Path Validation
```python
- Parent directory exists
- Parent directory is writable
- If output file exists, it is writable
- Path is not a directory
```

### Execution Validation
```python
- setup.sh exits with code 0
- command.sh exits with code 0
- usage.json exists after command execution
- con-duct successfully generates plot from usage.json
```

## Error Handling

**Entry Level (non-fatal, skip entry)**:
- Missing setup.sh: Skip entry, log error
- Missing command.sh: Skip entry, log error
- setup.sh fails: Skip entry, log execution error
- command.sh fails: Skip entry, log execution error
- usage.json not generated: Skip entry, log error
- Plot generation fails: Skip entry, log error
- Invalid metadata.json: Use empty dict, log warning

**Output Level (fatal, exit immediately)**:
- Invalid output path: Fail before any execution
- No valid entries found: Fail after discovery
- Write failure: Fail, preserve error details
