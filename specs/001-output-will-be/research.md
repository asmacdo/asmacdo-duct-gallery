# Research: Gallery Markdown Output

## Technology Decisions

### Language: Python 3.11+
**Decision**: Use Python 3.11+ for implementation

**Rationale**:
- Con-duct is a Python package (`pip install con-duct[all]` includes matplotlib)
- Standard library provides all needed functionality (pathlib, argparse)
- Team familiarity with Python
- Cross-platform compatibility
- Simple file I/O and text manipulation

**Alternatives Considered**:
- Bash script: Harder to test, less maintainable for complex logic
- Go/Rust: Overkill for file reading + text generation, adds dependency overhead

### Dependencies: Minimal
**Decision**: Use Python standard library + con-duct[all]

**Rationale**:
- `pathlib`: Modern path handling
- `argparse`: CLI argument parsing
- `json`: Read metadata.json files
- `con-duct[all]`: Already required (includes matplotlib for plots)
- No external markdown libraries needed (simple string concatenation)

**Alternatives Considered**:
- Jinja2/Mako templates: Over-engineering for simple markdown generation
- Click for CLI: argparse sufficient for simple interface
- Markdown libraries: Not needed, we're generating simple markdown syntax

### Entry Discovery and Execution Strategy
**Decision**: Scan `gallery/` directory, execute each entry's scripts, generate plots

**Rationale**:
- Discover entries by scanning for subdirectories
- Each entry must have: setup.sh, command.sh
- Execute setup.sh to prepare environment/data
- Execute command.sh (datalad run + duct) to generate usage.json
- Use con-duct to generate plot from usage.json
- Full automation: no manual plot generation needed

**Alternatives Considered**:
- Pre-generated plots: Violates automation principle
- Explicit entry list file: Adds maintenance burden
- Database/index: Over-engineering

### Markdown Generation Approach
**Decision**: Template-based string formatting

**Rationale**:
- Output format is simple and fixed
- Each entry = heading + code block + image embed
- Python f-strings or format() sufficient
- Easy to test and verify output

**Alternatives Considered**:
- Markdown AST libraries: Unnecessary complexity
- Template engines: Overkill for fixed structure

### Plot Generation Strategy
**Decision**: Use con-duct to generate plots from usage.json after execution

**Rationale**:
- con-duct[all] includes matplotlib for plotting
- usage.json contains all resource usage data from duct
- Automated plot generation ensures consistency
- Standard con-duct plot commands available

**Alternatives Considered**:
- Manual plot creation: Violates automation principle
- Custom plotting code: Reinventing con-duct functionality

### Plot Path Resolution
**Decision**: Relative paths from output markdown file location

**Rationale**:
- Markdown viewers expect relative paths
- Output location is configurable
- Calculate relative path from output to each entry's `plots/` directory
- Plots generated to entry-specific plots/ directory

**Alternatives Considered**:
- Absolute paths: Breaks portability
- Base64 encoding: Bloats file size, harder to view source
- Copy plots to central location: Duplicates data, violates simplicity

### Configuration
**Decision**: CLI arguments for output path, gallery directory optional

**Rationale**:
- Simple invocation: `gallery-render -o output.md`
- Optional: `--gallery-dir` (defaults to `./gallery`)
- Aligns with "configurable output location" requirement

**Alternatives Considered**:
- Config file: Premature for single setting
- Environment variables: Less discoverable

### Error Handling
**Decision**: Fail fast with clear error messages

**Rationale**:
- Invalid output path: Validate writable before generation
- Missing required entry files: Skip entry, log warning, continue
- No entries found: Error and exit
- Simplicity principle: Don't hide failures

**Alternatives Considered**:
- Silent failures: Violates transparency
- Partial generation: Could create incomplete documentation

## Implementation Notes

### Entry Execution Flow
For each gallery entry:
1. Validate setup.sh and command.sh exist and are executable
2. Execute setup.sh in entry directory (prep environment/data)
3. Execute command.sh in entry directory (datalad run + duct → usage.json)
4. Execute con-duct plot command on usage.json → plots/
5. Read command text from command.sh for markdown display
6. Calculate relative path from output file to generated plot

### Entry Structure Validation
Each gallery entry must have:
1. `setup.sh` - Executable script for environment setup
2. `command.sh` - Executable script containing datalad run + duct command
3. `metadata.json` - Optional metadata (read if exists)

After execution, entry will have:
- `.duct/usage.json` - Generated by duct
- `plots/<name>.png` - Generated by con-duct from usage.json

### Con-duct Plot Generation
```bash
# Example con-duct command to generate plot from usage.json
con-duct plot -i gallery/entry-name/.duct/usage.json -o gallery/entry-name/plots/usage.png
```

### Markdown Format
```markdown
# Gallery

## Entry: <entry-name>

\```bash
<contents of command.sh>
\```

![Plot](<relative-path-to-plot>)

---
```

### Testing Strategy
1. **Unit tests**: Entry discovery, script execution wrapper, path resolution, markdown formatting
2. **Integration tests**: Full execution pipeline with fixture gallery entries
3. **Manual verification**: Visual inspection of generated markdown and plots

### Performance Considerations
- Entry execution (setup + duct command) is main bottleneck
- Entries can be executed sequentially (parallelization future enhancement)
- No optimization needed for initial scope (10-50 entries)
- Future: Consider parallel execution if >100 entries
